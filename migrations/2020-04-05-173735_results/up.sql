-- Your SQL goes here

CREATE TABLE symbol_sets (
       symbol_set_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
);

CREATE TABLE set_symbols (
       symbol_set_id INTEGER NOT NULL REFERENCES symbol_sets(symbol_set_id) PRIMARY KEY,
       symbol VARCHAR(10) NOT NULL
       -- CONSTRAINT symbol_set_pk PRIMARY KEY trade_symbols_id
);

-- TODO insert all major pairs as index 1

CREATE TABLE run_sessions (
       session_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
       start_date DATE NOT NULL,
       end_date DATE NOT NULL,
       expert_version UUID,
       symbol_set_id INTEGER NOT NULL REFERENCES symbol_sets(symbol_set_id)
);


CREATE TABLE expert_inputs (
       session_id INTEGER NOT NULL REFERENCES run_sessions(session_id) ON UPDATE CASCADE ON DELETE CASCADE,
       input_name VARCHAR(20) NOT NULL,
       input NUMERIC(12,4),
       start NUMERIC(12,4),
       stop NUMERIC(12,4),
       step NUMERIC(12,4),
       str_input VARCHAR(100),
       CONSTRAINT input_notnull CHECK ((
         input IS NOT NULL
         OR NOT ( start IS NULL OR stop IS NULL or step IS NULL )
         OR str_input IS NOT NULL
       )), -- either input needs to be set or all of start,stop,step
       CONSTRAINT expert_inputs_pk PRIMARY KEY (session_id, input_name)
);

CREATE TABLE runs (
       run_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
       session_id INTEGER NOT NULL REFERENCES run_sessions(session_id),
       run_date TIMESTAMP NOT NULL,
       indicator_set_id BIGINT NOT NULL REFERENCES indicator_sets(indicator_set_id) -- most likely ranged
);

CREATE TABLE results (
       result_id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
       run_id BIGINT NOT NULL REFERENCES runs(run_id) ON UPDATE CASCADE ON DELETE CASCADE,
       result FLOAT4 NOT NULL, -- the result generated by tester  <- this might be useless
       profit FLOAT4 NOT NULL,
       expected_payoff FLOAT4 NOT NULL,
       profit_factor FLOAT4 NOT NULL,
       recovery_factor FLOAT4 NOT NULL,
       sharpe_ratio FLOAT4 NOT NULL,
       custom_result FLOAT4 NOT NULL,
       equity_drawdown FLOAT4 NOT NULL,
       trades INTEGER NOT NULL CHECK(trades >= 0)
);

CREATE TABLE result_sets (
       result_id BIGINT REFERENCES results(result_id) ON UPDATE CASCADE ON DELETE CASCADE,
       -- run_id BIGINT NOT NULL REFERENCES runs(run_id),
       inputs_id BIGINT REFERENCES indicator_inputs_explicit(inputs_id) ON UPDATE CASCADE ON DELETE CASCADE,
       -- indicator_set_id BIGINT NOT NULL REFERENCES indicator_sets(indicator_set_id) -- parent indicator_set
       CONSTRAINT result_sets_pk PRIMARY KEY (result_id, inputs_id)
);
